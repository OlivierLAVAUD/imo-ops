# SUPPRIMER la ligne version: '3.8' (obsolète)

services:
  mongodb:
    image: mongo:6.0
    container_name: mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
    ports:
      - "${MONGO_PORT}:27017"
    volumes:
      - mongo_data:/data/db
      - ./data/imports:/docker-entrypoint-initdb.d:ro
    command: 
      - "--bind_ip_all"
      - "--auth"
    healthcheck:
      test: |
        mongosh --eval "
          db.adminCommand('ping')
        " --quiet
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - imo-ops-network

  data-importer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: data-importer
    restart: "no"
    environment:
      # Variables pour MongoDB - CORRIGÉES
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_DB=${MONGO_DATABASE}
      - MONGO_USER=${MONGO_ROOT_USERNAME}
      - MONGO_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_AUTH_SOURCE=admin 
      
      # Chemins des fichiers
      - CONFIG_FILE_PATH=/app/config/config_aggreges.json
      - DATA_FILE_PATH=/app/data/annonces_agregees.json
      - LOGS_DIRECTORY=/app/logs
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./data:/app/data:ro
      - ./config:/app/config:ro
      - ./import_logs:/app/logs
      - ./scripts:/app/scripts:ro
    networks:
      - imo-ops-network
    profiles:
      - import

volumes:
  mongo_data:

networks:
  imo-ops-network:
    driver: bridge